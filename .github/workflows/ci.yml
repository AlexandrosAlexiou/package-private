name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Primary build: JVM, JS, Wasm, Linux, and Windows targets
  # Runs on Ubuntu for speed and cost efficiency
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build and test (JVM, JS, Wasm, Linux, Windows)
        run: |
          ./gradlew build test \
            -x :package-private-annotations:compileKotlinIosArm64 \
            -x :package-private-annotations:compileKotlinIosSimulatorArm64 \
            -x :package-private-annotations:compileKotlinIosX64 \
            -x :package-private-annotations:compileKotlinMacosArm64 \
            -x :package-private-annotations:compileKotlinMacosX64 \
            -x :package-private-annotations:compileKotlinWatchosArm32 \
            -x :package-private-annotations:compileKotlinWatchosArm64 \
            -x :package-private-annotations:compileKotlinWatchosSimulatorArm64 \
            -x :package-private-annotations:compileKotlinWatchosX64 \
            -x :package-private-annotations:compileKotlinTvosArm64 \
            -x :package-private-annotations:compileKotlinTvosSimulatorArm64 \
            -x :package-private-annotations:compileKotlinTvosX64 \
            -x :package-private-annotations:iosArm64Klib \
            -x :package-private-annotations:iosSimulatorArm64Klib \
            -x :package-private-annotations:iosX64Klib \
            -x :package-private-annotations:macosArm64Klib \
            -x :package-private-annotations:macosX64Klib \
            -x :package-private-annotations:watchosArm32Klib \
            -x :package-private-annotations:watchosArm64Klib \
            -x :package-private-annotations:watchosSimulatorArm64Klib \
            -x :package-private-annotations:watchosX64Klib \
            -x :package-private-annotations:tvosArm64Klib \
            -x :package-private-annotations:tvosSimulatorArm64Klib \
            -x :package-private-annotations:tvosX64Klib \
            -x :package-private-annotations:generateMetadataFileForIosArm64Publication \
            -x :package-private-annotations:generateMetadataFileForIosSimulatorArm64Publication \
            -x :package-private-annotations:generateMetadataFileForIosX64Publication \
            -x :package-private-annotations:generateMetadataFileForMacosArm64Publication \
            -x :package-private-annotations:generateMetadataFileForMacosX64Publication \
            -x :package-private-annotations:generateMetadataFileForWatchosArm32Publication \
            -x :package-private-annotations:generateMetadataFileForWatchosArm64Publication \
            -x :package-private-annotations:generateMetadataFileForWatchosSimulatorArm64Publication \
            -x :package-private-annotations:generateMetadataFileForWatchosX64Publication \
            -x :package-private-annotations:generateMetadataFileForTvosArm64Publication \
            -x :package-private-annotations:generateMetadataFileForTvosSimulatorArm64Publication \
            -x :package-private-annotations:generateMetadataFileForTvosX64Publication \
            -x :package-private-annotations:publishIosArm64PublicationToMavenLocal \
            -x :package-private-annotations:publishIosSimulatorArm64PublicationToMavenLocal \
            -x :package-private-annotations:publishIosX64PublicationToMavenLocal \
            -x :package-private-annotations:publishMacosArm64PublicationToMavenLocal \
            -x :package-private-annotations:publishMacosX64PublicationToMavenLocal \
            -x :package-private-annotations:publishWatchosArm32PublicationToMavenLocal \
            -x :package-private-annotations:publishWatchosArm64PublicationToMavenLocal \
            -x :package-private-annotations:publishWatchosSimulatorArm64PublicationToMavenLocal \
            -x :package-private-annotations:publishWatchosX64PublicationToMavenLocal \
            -x :package-private-annotations:publishTvosArm64PublicationToMavenLocal \
            -x :package-private-annotations:publishTvosSimulatorArm64PublicationToMavenLocal \
            -x :package-private-annotations:publishTvosX64PublicationToMavenLocal

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: '**/build/reports/tests/'

  # Apple platform build: iOS, macOS, watchOS, tvOS targets
  # Requires macOS runner for Xcode toolchain
  build-apple:
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build and test (Apple targets only)
        run: |
          ./gradlew \
            :package-private-annotations:compileKotlinIosArm64 \
            :package-private-annotations:compileKotlinIosSimulatorArm64 \
            :package-private-annotations:compileKotlinIosX64 \
            :package-private-annotations:compileKotlinMacosArm64 \
            :package-private-annotations:compileKotlinMacosX64 \
            :package-private-annotations:compileKotlinWatchosArm32 \
            :package-private-annotations:compileKotlinWatchosArm64 \
            :package-private-annotations:compileKotlinWatchosSimulatorArm64 \
            :package-private-annotations:compileKotlinWatchosX64 \
            :package-private-annotations:compileKotlinTvosArm64 \
            :package-private-annotations:compileKotlinTvosSimulatorArm64 \
            :package-private-annotations:compileKotlinTvosX64
